<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MongoDB Sharding - Advanced Interactive Experience</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #1a73e8;
      --secondary: #0d47a1;
      --accent: #00bcd4;
      --light: #e3f2fd;
      --dark: #0d2b4b;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --text: #333;
      --text-light: #f5f5f5;
      --card-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      --glow: 0 0 20px rgba(26, 115, 232, 0.3);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="dark"] {
      --primary: #4285f4;
      --secondary: #1976d2;
      --accent: #26c6da;
      --light: #263238;
      --dark: #1a1a1a;
      --text: #e0e0e0;
      --text-light: #ffffff;
      --card-bg: rgba(33, 33, 33, 0.95);
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Roboto", sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a2a6c, #2a4d69, #0d2b4b);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    @keyframes gradientBG {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 30px 0;
      margin-bottom: 30px;
      color: var(--text-light);
      position: relative;
    }

    .header-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .theme-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50px;
      padding: 10px 15px;
      color: var(--text-light);
      cursor: pointer;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .performance-indicator {
      background: var(--success);
      border-radius: 50px;
      padding: 8px 12px;
      font-size: 0.8rem;
      font-weight: bold;
      color: white;
      display: flex;
      align-items: center;
      gap: 5px;
      animation: pulse-indicator 2s infinite;
    }

    @keyframes pulse-indicator {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .logo {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--accent);
      text-shadow: 0 0 20px rgba(0, 188, 212, 0.5);
    }

    header h1 {
      font-size: 2.4rem;
      margin-bottom: 15px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }

    .subtitle {
      font-size: 1.1rem;
      max-width: 850px;
      margin: 0 auto 25px;
      line-height: 1.6;
      color: var(--text-light);
      opacity: 0.9;
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .tab {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 50px;
      padding: 12px 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      color: var(--text-light);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .tab.active {
      background: var(--primary);
      box-shadow: 0 5px 15px rgba(26, 115, 232, 0.4);
      border-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .visualization-container {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-bottom: 40px;
    }

    .shard-cluster {
      flex: 3;
      min-width: 700px;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 25px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .shard-cluster::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 50% 50%, rgba(26, 115, 232, 0.05) 0%, transparent 70%);
      pointer-events: none;
      z-index: 1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0.6;
      animation: float 6s infinite linear;
      pointer-events: none;
      z-index: 2;
    }

    @keyframes float {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 0.6;
      }
      90% {
        opacity: 0.6;
      }
      100% {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
      }
    }

    .controls {
      flex: 1;
      min-width: 300px;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 25px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .section-title {
      font-size: 1.6rem;
      margin-bottom: 16px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 10px;
    }

    .section-title i {
      font-size: 1.2rem;
      color: var(--accent);
    }

    .mongos-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 40px;
    }

    .mongos {
      background: linear-gradient(45deg, #ff9800, #ff5722);
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4);
      position: relative;
      animation: pulse 2s infinite;
      cursor: pointer;
      transition: var(--transition);
      z-index: 10;
      user-select: none;
    }

    .mongos::after {
      content: '';
      position: absolute;
      top: -5px;
      right: -5px;
      width: 20px;
      height: 20px;
      background: var(--success);
      border-radius: 50%;
      border: 3px solid white;
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }

    .mongos:hover {
      transform: scale(1.05) rotate(5deg);
      box-shadow: var(--glow);
    }

    .mongos i {
      font-size: 2.1rem;
      margin-bottom: 6px;
    }

    .shards-container {
      display: flex;
      justify-content: space-around;
      gap: 20px;
      margin-top: 40px;
      flex-wrap: wrap;
    }

    .shard {
      background: rgba(26, 115, 232, 0.08);
      border-radius: 15px;
      padding: 20px;
      min-width: 220px;
      text-align: center;
      position: relative;
      transition: var(--transition);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(26, 115, 232, 0.15);
      z-index: 10;
      overflow: hidden;
    }

    .shard::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
      background-size: 200% 100%;
      animation: load-bar 3s infinite;
    }

    @keyframes load-bar {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .shard:hover {
      background: rgba(26, 115, 232, 0.15);
      transform: translateY(-5px) scale(1.02);
      box-shadow: var(--glow);
    }

    .shard-status {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 10px currentColor;
      animation: pulse-status 2s infinite;
    }

    @keyframes pulse-status {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }

    .shard-header {
      font-size: 1.1rem;
      margin-bottom: 12px;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
    }

    .chunks {
      min-height: 260px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .chunk {
      background: rgba(0, 150, 136, 0.8);
      padding: 12px;
      border-radius: 8px;
      transition: all 0.2s ease;
      cursor: grab;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      font-weight: 500;
      position: relative;
      user-select: none;
    }

    .chunk:active {
      cursor: grabbing;
    }

    .chunk:hover {
      background: rgba(0, 150, 136, 0.95);
      transform: scale(1.02);
    }

    .config-servers {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 40px;
      z-index: 10;
      flex-wrap: wrap;
    }

    .config-server {
      background: linear-gradient(45deg, #7b1fa2, #4a148c);
      width: 100px;
      height: 100px;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      box-shadow: 0 5px 15px rgba(123, 31, 162, 0.4);
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .config-server:hover {
      transform: scale(1.08);
    }

    .config-server i {
      font-size: 1.6rem;
      margin-bottom: 6px;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .control-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 1.05rem;
      color: var(--dark);
      font-weight: 500;
    }

    .slider-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.9rem;
      color: #333;
    }

    input[type="range"] {
      width: 100%;
      height: 10px;
      -webkit-appearance: none;
      background: rgba(26, 115, 232, 0.2);
      border-radius: 5px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .value-display {
      display: inline-flex;
      min-width: 42px;
      text-align: center;
      background: rgba(26, 115, 232, 0.1);
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: 600;
      color: var(--primary);
      margin-left: 6px;
    }

    button {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 12px 16px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      margin-top: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }

    button:hover {
      background: linear-gradient(45deg, #0d47a1, #002171);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(13, 71, 161, 0.4);
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .info-box {
      background: rgba(26, 115, 232, 0.06);
      border-left: 4px solid var(--primary);
      padding: 16px;
      border-radius: 0 8px 8px 0;
      margin-top: 16px;
    }

    .info-box h3 {
      margin-bottom: 10px;
      color: var(--primary);
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .info-box ul {
      padding-left: 18px;
    }

    .info-box li {
      margin-bottom: 8px;
      line-height: 1.45;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
      }

      70% {
        box-shadow: 0 0 0 15px rgba(255, 152, 0, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
      }
    }

    /* OLD data-flow, now used for bus and connectors */
    .data-flow {
      position: absolute;
      background: var(--dark);
      z-index: 1;
    }

    .network-bus {
      height: 4px;
    }
    
    .data-flow-animation {
      position: absolute;
      background: linear-gradient(90deg, #00bcd4, #ff9800);
      border-radius: 2px;
      z-index: 5;
      transform-origin: left;
    }

    @keyframes flow {
      from {
        transform: scaleY(0);
        opacity: 0;
      }
      50% {
        opacity: 1;
      }
      to {
        transform: scaleY(1);
        opacity: 1;
      }
    }


    @media (max-width: 1100px) {
      .visualization-container {
        flex-direction: column;
      }

      .shard-cluster,
      .controls {
        min-width: 100%;
      }
    }

    .explanation {
      margin-top: 30px;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .explanation h2 {
      color: var(--primary);
      margin-bottom: 15px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 10px;
    }

    .explanation p {
      margin-bottom: 12px;
      line-height: 1.7;
      color: var(--text);
    }

    .key-term {
      color: var(--primary);
      font-weight: 700;
    }

    .step-by-step {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      margin: 18px 0 8px;
    }

    .step {
      flex: 1;
      min-width: 260px;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 16px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--accent);
      transition: all 0.2s ease;
    }

    .step:hover {
      transform: translateY(-4px);
      border-left-color: var(--primary);
    }

    .step-number {
      background: var(--primary);
      color: white;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .simulation-area {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: var(--shadow);
    }

    .simulation-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .simulation-input {
      flex: 1;
      min-width: 280px;
      padding: 12px 14px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .simulation-result {
      margin-top: 12px;
      padding: 12px;
      background: rgba(26, 115, 232, 0.05);
      border-radius: 8px;
      min-height: 100px;
      border-left: 4px solid var(--primary);
    }

    .shard-key-example {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .key-option {
      padding: 8px 12px;
      background: rgba(26, 115, 232, 0.1);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }

    .key-option:hover {
      background: rgba(26, 115, 232, 0.2);
    }

    .key-option.active {
      background: var(--primary);
      color: white;
      border-color: var(--accent);
    }

    .faq-section {
      margin-top: 20px;
    }

    .faq-item {
      background: var(--card-bg);
      border-radius: 10px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .faq-question {
      padding: 16px;
      background: rgba(26, 115, 232, 0.07);
      font-weight: 500;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .faq-answer {
      padding: 0 16px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease;
    }
    
    .faq-answer ul {
      padding-left: 18px;
      margin-top: 10px;
    }

    .faq-item.active .faq-answer {
      padding: 16px;
      max-height: 500px;
    }

    footer {
      text-align: center;
      padding: 26px 0;
      margin-top: 34px;
      color: var(--text-light);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chunk-drag-ghost {
      position: absolute;
      padding: 10px;
      border-radius: 8px;
      background: rgba(0, 150, 136, 0.95);
      color: white;
      font-weight: 600;
      z-index: 1000;
      pointer-events: none;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      transform: translate(-50%, -50%);
    }

    .shard-dropzone {
      border: 2px dashed var(--primary);
      background: rgba(26, 115, 232, 0.08);
      transition: all 0.2s;
    }

    .shard-dropzone.highlight {
      border-color: var(--success);
      background: rgba(76, 175, 80, 0.15);
      transform: scale(1.02);
    }

    .performance-metrics {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .metric-card {
      flex: 1;
      min-width: 150px;
      background: var(--card-bg);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      box-shadow: var(--shadow);
    }

    .metric-value {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--primary);
      margin: 8px 0;
    }

    .metric-label {
      font-size: 0.9rem;
      color: var(--dark);
    }

    .comparison-chart {
      height: 300px;
      margin: 20px 0;
    }

    .interactive-console {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 12px;
      color: #d4d4d4;
      font-family: monospace;
      height: 200px;
      overflow-y: auto;
      margin-top: 8px;
    }

    .console-line {
      margin-bottom: 4px;
      line-height: 1.5;
    }

    .console-command {
      color: #4ec9b0;
    }

    .console-comment {
      color: #6a9955;
    }

    .console-error {
      color: #f44747;
    }

    .console-success {
      color: #4ec9b0;
    }

    /* Popup chi tiết chunk */
    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      z-index: 900;
    }

    .chunk-popup {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 12px;
      padding: 18px 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      z-index: 1000;
      width: min(420px, 92vw);
      display: none;
    }

    .chunk-popup h3 {
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .close-popup {
      position: absolute;
      top: 10px;
      right: 12px;
      cursor: pointer;
      font-size: 1.2rem;
      color: #777;
    }

    .chunk-popup-content p {
      margin: 6px 0;
    }

    /* Config popup */
    .config-popup {
      position: absolute;
      background: white;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
      z-index: 100;
      max-width: 420px;
      display: none;
    }

    .config-popup h3 {
      color: var(--primary);
      margin-bottom: 10px;
    }

    .config-popup pre {
      background: #f6f8fa;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
    }

    /* Distribution effect dynamic */
    .distribution-effect {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0 0;
    }

    .distribution-shard {
      text-align: center;
      padding: 8px 10px;
      border-radius: 8px;
      transition: all 0.2s ease;
      background: rgba(26, 115, 232, 0.1);
      font-weight: 600;
      min-width: 110px;
    }

    .shard-mini {
      background: var(--primary);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: bold;
    }

    /* Advanced Tools Styles */
    .tool-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .tool-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .tool-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--glow);
    }

    .tool-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
      color: var(--primary);
      font-weight: 600;
    }

    .code-editor {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Courier New', monospace;
      border-radius: 8px;
      padding: 15px;
      min-height: 200px;
      border: none;
      resize: vertical;
      font-size: 14px;
      line-height: 1.5;
    }

    .terminal-output {
      background: #000;
      color: #00ff00;
      font-family: monospace;
      padding: 15px;
      border-radius: 8px;
      min-height: 150px;
      overflow-y: auto;
      border: 1px solid #333;
    }

    /* Real-time Monitoring Styles */
    .monitor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .monitor-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      box-shadow: var(--shadow);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .monitor-value {
      font-size: 2.2rem;
      font-weight: 800;
      margin: 10px 0;
      background: linear-gradient(45deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .monitor-trend {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .trend-up {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success);
    }

    .trend-down {
      background: rgba(244, 67, 54, 0.2);
      color: var(--danger);
    }

    .monitor-chart {
      height: 100px;
      margin-top: 10px;
    }

  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="header-controls">
        <div class="performance-indicator">
          <i class="fas fa-circle"></i>
          <span>System Online</span>
        </div>
        <button class="theme-toggle" id="theme-toggle">
          <i class="fas fa-moon"></i>
        </button>
      </div>
      <div class="logo"><i class="fas fa-sitemap"></i></div>
      <h1>MongoDB Sharding - Advanced Interactive Experience</h1>
      <div class="tabs">
        <div class="tab active" data-tab="overview">Tổng Quan</div>
        <div class="tab" data-tab="visualization">Mô Phỏng</div>
        <div class="tab" data-tab="interaction">Thực Hành</div>
        <div class="tab" data-tab="performance">Hiệu Suất</div>
        <div class="tab" data-tab="faq">FAQ</div>
        <div class="tab" data-tab="advanced">Advanced Tools</div>
        <div class="tab" data-tab="monitoring">Real-time Monitor</div>
      </div>
    </header>

    <!-- Tổng quan về Sharding -->
    <div class="tab-content active" id="overview-tab">
      <div class="explanation">
        <h2><i class="fas fa-lightbulb"></i> Sharding trong MongoDB là gì?</h2>
        <p>Sharding là kỹ thuật <span class="key-term">phân phối dữ liệu</span> trên nhiều máy chủ (gọi là shard).
          MongoDB sử dụng sharding để hỗ trợ triển khai các bộ dữ liệu rất lớn và các hoạt động có thông lượng cao.</p>
        <div class="step-by-step">
          <div class="step">
            <div class="step-number">1</div>
            <h3>Vấn đề dữ liệu lớn</h3>
            <p>Khi dữ liệu tăng, một máy chủ duy nhất không thể đáp ứng</p>
            <div class="performance-metrics">
              <div class="metric-card">
                <div class="metric-value" id="single-server-latency">120ms</div>
                <div class="metric-label">Độ trễ</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="single-server-storage">85%</div>
                <div class="metric-label">Dung lượng</div>
              </div>
            </div>
          </div>
          <div class="step">
            <div class="step-number">2</div>
            <h3>Giải pháp Sharding</h3>
            <p>Chia dữ liệu thành các phần và phân phối trên nhiều máy chủ</p>
            <div class="performance-metrics">
              <div class="metric-card">
                <div class="metric-value" id="sharded-latency">32ms</div>
                <div class="metric-label">Độ trễ</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="sharded-storage">28%</div>
                <div class="metric-label">Dung lượng</div>
              </div>
            </div>
          </div>
        </div>
        <div class="comparison-chart"><canvas id="performanceChart"></canvas></div>
      </div>
    </div>

    <!-- Mô phỏng trực quan -->
    <div class="tab-content" id="visualization-tab">
      <div class="visualization-container">
        <div class="shard-cluster" id="interactive-cluster">
          <h2 class="section-title"><i class="fas fa-project-diagram"></i> Mô Hình Sharding Tương Tác</h2>

          <div class="mongos-container">
            <div class="mongos" id="mongos1" title="Mongos Router - Nhấp để mô phỏng"><i class="fas fa-random"></i>
              <div>Mongos 1</div>
            </div>
            <div class="mongos" id="mongos2" title="Mongos Router - Nhấp để mô phỏng"><i class="fas fa-random"></i>
              <div>Mongos 2</div>
            </div>
          </div>

          <div class="shards-container" id="shards-container">
            <!-- Shards khởi tạo ban đầu (3) sẽ được render bằng JS để dễ thêm/bớt động -->
          </div>

          <div class="config-servers">
            <div class="config-server" id="config1" title="Config Server 1 - Nhấp để xem metadata"><i
                class="fas fa-cogs"></i>
              <div>Config 1</div>
            </div>
            <div class="config-server" id="config2" title="Config Server 2 - Nhấp để xem metadata"><i
                class="fas fa-cogs"></i>
              <div>Config 2</div>
            </div>
            <div class="config-server" id="config3" title="Config Server 3 - Nhấp để xem metadata"><i
                class="fas fa-cogs"></i>
              <div>Config 3</div>
            </div>
          </div>

          <!-- Popup cho Config Server -->
          <div class="config-popup" id="config-popup">
            <span class="close-popup" id="close-config-popup">&times;</span>
            <h3>Metadata Config Server</h3>
            <p>Config server lưu trữ thông tin về:</p>
            <ul>
              <li>Vị trí của các shard</li>
              <li>Phân phối dữ liệu (chunk mapping)</li>
              <li>Thông tin cluster</li>
              <li>Trạng thái cân bằng</li>
            </ul>
            <p><strong>Dữ liệu mẫu:</strong></p>
            <pre>{
  "shards": [
    {"_id": "shard1", "host": "shard1.example.com"},
    {"_id": "shard2", "host": "shard2.example.com"},
    {"_id": "shard3", "host": "shard3.example.com"}
  ],
  "chunks": [
    {"shard": "shard1", "min": 1, "max": 1000},
    {"shard": "shard2", "min": 1001, "max": 2000}
  ]
}</pre>
          </div>
        </div>

        <div class="controls">
          <h2 class="section-title"><i class="fas fa-sliders-h"></i> Điều Khiển Mô Phỏng</h2>

          <div class="control-group">
            <label for="shards">Số lượng Shards: <span id="shard-count" class="value-display">3</span></label>
            <input type="range" id="shards" min="2" max="6" value="3" />
            <div class="slider-container"><span>Ít</span><span>Nhiều</span></div>
          </div>

          <div class="control-group">
            <label for="chunks">Số lượng Chunks: <span id="chunk-count" class="value-display">9</span></label>
            <input type="range" id="chunks" min="3" max="24" value="9" />
            <div class="slider-container"><span>Ít</span><span>Nhiều</span></div>
          </div>

          <div class="control-group">
            <label for="data-distribution">Chiến lược phân phối:</label>
            <select id="data-distribution" class="value-display">
              <option value="random">Ngẫu nhiên</option>
              <option value="shardkey">Theo Shard Key</option>
              <option value="loadbalance">Cân bằng tải</option>
              <option value="geo">Theo khu vực địa lý</option>
            </select>
            <div id="distribution-explanation" class="info-box" style="display: none; margin-top: 15px;"></div>
          </div>

          <button id="add-data"><i class="fas fa-plus-circle"></i> Thêm Dữ Liệu Mẫu</button>
          <button id="rebalance"><i class="fas fa-balance-scale"></i> Cân Bằng Lại Shards</button>
          <button id="simulate-query"><i class="fas fa-search"></i> Mô Phỏng Truy Vấn</button>

          <div class="info-box">
            <h3><i class="fas fa-info-circle"></i> Tương tác với mô hình</h3>
            <ul>
              <li>Nhấp vào <b>chunk</b> để xem chi tiết</li>
              <li><b>Kéo - thả</b> chunk giữa các shard (không bị nhân bản)</li>
              <li>Nhấp vào <b>Mongos</b> để mô phỏng truy vấn</li>
              <li>Nhấp vào <b>Config Server</b> để xem metadata</li>
            </ul>
          </div>

          <div class="distribution-effect" id="distribution-effect"><!-- sẽ render động --></div>
        </div>
      </div>

      <div class="explanation">
        <h2><i class="fas fa-tasks"></i> Quy Trình Sharding Tương Tác</h2>
        <div class="step-by-step">
          <div class="step" id="step-drag">
            <div class="step-number"><i class="fas fa-hand-pointer"></i></div>
            <h3>Kéo chunk để cân bằng dữ liệu</h3>
            <p>Kéo một chunk từ shard này sang shard khác</p>
            <p id="drag-instruction">Kéo chunk ở trên và thả vào shard khác</p>
          </div>
          <div class="step">
            <div class="step-number"><i class="fas fa-bolt"></i></div>
            <h3>Mô phỏng truy vấn</h3>
            <p>Nhấp vào nút "Mô Phỏng Truy Vấn" để xem định tuyến</p>
          </div>
          <div class="step">
            <div class="step-number"><i class="fas fa-plus"></i></div>
            <h3>Thêm dữ liệu mới</h3>
            <p>Thêm dữ liệu mới và quan sát phân phối</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Khu vực thực hành tương tác -->
    <div class="tab-content" id="interaction-tab">
      <div class="explanation">
        <h2><i class="fas fa-hands"></i> Khu Vực Thực Hành Tương Tác</h2>
        <div class="step-by-step">
          <div class="step">
            <div class="step-number">1</div>
            <h3>Chọn Shard Key</h3>
            <p>Thử chọn các shard key khác nhau và xem cách dữ liệu phân phối:</p>
            <div class="shard-key-example">
              <div class="key-option active" data-key="user_id">user_id</div>
              <div class="key-option" data-key="timestamp">timestamp</div>
              <div class="key-option" data-key="location">location</div>
              <div class="key-option" data-key="product">product</div>
            </div>
            <div class="comparison-chart"><canvas id="distributionChart"></canvas></div>
            <div id="key-explanation" class="simulation-result">
              <p><strong>Giải thích:</strong> Khi chọn shard key "user_id", dữ liệu được phân phối đều giữa các shard
              </p>
            </div>
          </div>

          <div class="step">
            <div class="step-number">2</div>
            <h3>Mô phỏng truy vấn</h3>
            <p>Nhập một truy vấn và xem nó được xử lý như thế nào:</p>
            <div class="simulation-controls">
              <input type="text" class="simulation-input" id="interactive-query" placeholder='{"user_id": 2500}' />
              <button id="run-query"><i class="fas fa-play"></i> Thực thi truy vấn</button>
            </div>
            <div class="interactive-console" id="query-console">
              <div class="console-line">&gt; Chờ lệnh...</div>
            </div>
            <div id="query-visual" class="simulation-result" style="min-height: 140px; text-align: center;">
              <p>Kết quả trực quan sẽ hiển thị ở đây</p>
            </div>
          </div>

          <div class="step">
            <div class="step-number">3</div>
            <h3>Thiết kế kiến trúc của bạn</h3>
            <p>Xây dựng kiến trúc sharding cho ứng dụng của bạn:</p>
            <div class="simulation-controls">
              <label>Số lượng Shards:</label>
              <input type="number" min="2" max="15" value="3" id="custom-shards"
                style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;" />
              <label>Dữ liệu ước tính:</label>
              <select id="custom-data" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option>1TB</option>
                <option selected>10TB</option>
                <option>100TB</option>
                <option>1PB</option>
              </select>
            </div>
            <button id="design-architecture"><i class="fas fa-drafting-compass"></i> Thiết kế kiến trúc</button>
            <div id="architecture-result" class="simulation-result">
                <p>Kết quả đề xuất kiến trúc của bạn sẽ xuất hiện ở đây sau khi bạn nhấp vào nút "Thiết kế".</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Phân tích hiệu suất -->
    <div class="tab-content" id="performance-tab">
      <div class="explanation">
        <h2><i class="fas fa-tachometer-alt"></i> Phân Tích Hiệu Suất Sharding</h2>
        <div class="step-by-step">
          <div class="step">
            <div class="step-number">1</div>
            <h3>So sánh hiệu suất</h3>
            <p>Hiệu suất của kiến trúc không sharding vs có sharding:</p>
            <div class="comparison-chart"><canvas id="performanceComparisonChart"></canvas></div>
          </div>
          <div class="step">
            <div class="step-number">2</div>
            <h3>Mô phỏng tải</h3>
            <p>Thử nghiệm với các mức tải khác nhau:</p>
            <div class="control-group">
              <label for="load-level">Mức độ tải: <span id="load-value" class="value-display">Trung bình</span></label>
              <input type="range" id="load-level" min="1" max="3" value="2" />
              <div class="slider-container"><span>Thấp</span><span>Cao</span></div>
              <small style="display: block; text-align: center; margin-top: 5px; color: #555;">Sử dụng thanh trượt để điều chỉnh</small>
            </div>
            <div class="performance-metrics">
              <div class="metric-card">
                <div class="metric-value" id="throughput-value">1,250</div>
                <div class="metric-label">Truy vấn/giây</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="latency-value">42ms</div>
                <div class="metric-label">Độ trễ</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="cpu-value">65%</div>
                <div class="metric-label">Sử dụng CPU</div>
              </div>
            </div>
          </div>
          <div class="step">
            <div class="step-number">3</div>
            <h3>Mở rộng hệ thống</h3>
            <p>Thêm shard mới và xem hiệu suất thay đổi:</p>
            <button id="add-shard"><i class="fas fa-plus"></i> Thêm Shard Mới</button>
            <div class="comparison-chart"><canvas id="scalabilityChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="faq-tab">
      <div class="explanation">
        <h2><i class="fas fa-question-circle"></i> Câu Hỏi Thường Gặp (FAQ)</h2>
        <div class="faq-section">
          <div class="faq-item">
            <div class="faq-question"><span>Shard là gì?</span><i class="fas fa-chevron-down"></i></div>
            <div class="faq-answer">
              <p>Một shard là một máy chủ hoặc một cụm máy chủ lưu trữ một phần dữ liệu của toàn bộ collection. Mỗi
                shard có thể là một replica set để đảm bảo tính sẵn sàng cao.</p>
            </div>
          </div>
          <div class="faq-item">
            <div class="faq-question"><span>Shard key là gì và tại sao nó quan trọng?</span><i
                class="fas fa-chevron-down"></i></div>
            <div class="faq-answer">
              <p>Shard key là một trường hoặc một tập hợp các trường trong tài liệu được sử dụng để phân phối dữ liệu
                trên các shard. Việc chọn shard key tốt là rất quan trọng để đảm bảo dữ liệu được phân phối đều và hiệu
                suất truy vấn cao.</p>
            </div>
          </div>
          <div class="faq-item">
            <div class="faq-question"><span>Chunk là gì?</span><i class="fas fa-chevron-down"></i></div>
            <div class="faq-answer">
              <p>Một chunk là một dải liên tục của các giá trị shard key. MongoDB chia dữ liệu thành các chunk và phân
                phối chúng trên các shard. Mỗi chunk có kích thước mặc định là 64MB.</p>
            </div>
          </div>
          <div class="faq-item">
            <div class="faq-question"><span>Mongos là gì?</span><i class="fas fa-chevron-down"></i></div>
            <div class="faq-answer">
              <p><span class="key-term">Mongos</span> hoạt động như một bộ định tuyến truy vấn (query router), cung cấp một giao diện từ các ứng dụng khách đến cụm sharded. Ứng dụng không kết nối trực tiếp đến các shard mà kết nối đến Mongos, Mongos sẽ định tuyến truy vấn đến shard phù hợp.</p>
            </div>
          </div>
          <div class="faq-item">
            <div class="faq-question"><span>Balancer (bộ cân bằng) là gì?</span><i class="fas fa-chevron-down"></i></div>
            <div class="faq-answer">
              <p>Balancer là một tiến trình nền chạy trong cụm sharded, có nhiệm vụ di chuyển các chunk giữa các shard để đảm bảo dữ liệu được phân phối đều. Nó hoạt động tự động để ngăn chặn một shard bị quá tải trong khi các shard khác còn trống.</p>
            </div>
          </div>
          <div class="faq-item">
            <div class="faq-question"><span>Điều gì xảy ra khi một shard bị lỗi?</span><i class="fas fa-chevron-down"></i></div>
            <div class="faq-answer">
              <p>Để đảm bảo tính sẵn sàng cao, mỗi shard thường được triển khai dưới dạng một <span class="key-term">replica set</span> (tập hợp bản sao). Nếu một node chính (primary) trong shard bị lỗi, một trong các node phụ (secondary) sẽ tự động được bầu làm node chính mới, đảm bảo cụm vẫn hoạt động mà không bị gián đoạn.</p>
            </div>
          </div>
          <div class="faq-item">
            <div class="faq-question"><span>Làm thế nào để chọn một Shard Key tốt?</span><i class="fas fa-chevron-down"></i></div>
            <div class="faq-answer">
              <p>Một shard key tốt có ba đặc điểm chính:</p>
              <ul>
                <li><strong>Cardinality cao:</strong> Có nhiều giá trị duy nhất, giúp phân phối dữ liệu trên nhiều chunk.</li>
                <li><strong>Tần suất thay đổi thấp:</strong> Giá trị của shard key không nên thay đổi thường xuyên.</li>
                <li><strong>Không đơn điệu tăng/giảm:</strong> Tránh các key luôn tăng (như timestamp hoặc `_id` mặc định) vì chúng có thể gây ra "hot shard", tức là tất cả các lượt ghi mới đều đi vào cùng một shard.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p>MongoDB Sharding Interactive Experience &copy; 2025 - Nguyễn Ngọc Khánh</p>
    </footer>

    <!-- Advanced Tools Tab -->
    <div class="tab-content" id="advanced-tab">
      <div class="explanation">
        <h2><i class="fas fa-tools"></i> Advanced MongoDB Sharding Tools</h2>
        <div class="tool-grid">
          <div class="tool-card">
            <div class="tool-header">
              <i class="fas fa-code"></i>
              <h3>Shard Key Analyzer</h3>
            </div>
            <p>Analyze your data distribution and get recommendations for optimal shard keys.</p>
            <textarea class="code-editor" id="data-sample" placeholder="Paste your MongoDB document sample here...
{
  \"user_id\": 12345,
  \"timestamp\": \"2023-01-01T10:00:00Z\",
  \"location\": \"US-East\",
  \"product_id\": \"ABC123\"
}"></textarea>
            <button id="analyze-shard-key"><i class="fas fa-search"></i> Analyze Shard Key</button>
            <div class="terminal-output" id="shard-analysis-result">
              <div>Ready for analysis...</div>
            </div>
          </div>

          <div class="tool-card">
            <div class="tool-header">
              <i class="fas fa-database"></i>
              <h3>Chunk Migration Simulator</h3>
            </div>
            <p>Simulate chunk migration scenarios and their impact on performance.</p>
            <div class="control-group">
              <label for="migration-strategy">Migration Strategy:</label>
              <select id="migration-strategy">
                <option value="manual">Manual Migration</option>
                <option value="auto-balance">Auto Balancer</option>
                <option value="drain-shard">Drain Shard</option>
                <option value="zone-migration">Zone-based Migration</option>
              </select>
            </div>
            <div class="control-group">
              <label for="chunks-to-migrate">Chunks to Migrate: <span id="migration-count" class="value-display">5</span></label>
              <input type="range" id="chunks-to-migrate" min="1" max="20" value="5" />
            </div>
            <button id="simulate-migration"><i class="fas fa-exchange-alt"></i> Simulate Migration</button>
            <div class="comparison-chart"><canvas id="migrationChart"></canvas></div>
          </div>

          <div class="tool-card">
            <div class="tool-header">
              <i class="fas fa-shield-alt"></i>
              <h3>Security & Compliance Checker</h3>
            </div>
            <p>Validate your sharding configuration against security best practices.</p>
            <div class="control-group">
              <label>
                <input type="checkbox" id="check-auth" checked> Authentication Enabled
              </label>
            </div>
            <div class="control-group">
              <label>
                <input type="checkbox" id="check-ssl"> SSL/TLS Encryption
              </label>
            </div>
            <div class="control-group">
              <label>
                <input type="checkbox" id="check-audit" checked> Audit Logging
              </label>
            </div>
            <button id="run-security-check"><i class="fas fa-lock"></i> Run Security Check</button>
            <div class="terminal-output" id="security-result">
              <div>Security check results will appear here...</div>
            </div>
          </div>

          <div class="tool-card">
            <div class="tool-header">
              <i class="fas fa-chart-line"></i>
              <h3>Query Performance Profiler</h3>
            </div>
            <p>Profile query performance across shards and identify bottlenecks.</p>
            <textarea class="code-editor" id="query-input" placeholder="Enter your MongoDB query...
Example:
db.users.find({user_id: {$gte: 1000, $lt: 2000}})
.sort({timestamp: -1})
.limit(100)"></textarea>
            <button id="profile-query"><i class="fas fa-stopwatch"></i> Profile Query</button>
            <div class="comparison-chart"><canvas id="queryProfileChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Real-time Monitoring Tab -->
    <div class="tab-content" id="monitoring-tab">
      <div class="explanation">
        <h2><i class="fas fa-desktop"></i> Real-time Cluster Monitoring</h2>
        <div class="monitor-grid">
          <div class="monitor-card">
            <div class="monitor-trend trend-up">↗ +5%</div>
            <h3>Operations/sec</h3>
            <div class="monitor-value" id="ops-per-sec">1,247</div>
            <div class="monitor-chart"><canvas id="opsChart"></canvas></div>
          </div>
          
          <div class="monitor-card">
            <div class="monitor-trend trend-down">↘ -12ms</div>
            <h3>Average Latency</h3>
            <div class="monitor-value" id="avg-latency">42ms</div>
            <div class="monitor-chart"><canvas id="latencyChart"></canvas></div>
          </div>
          
          <div class="monitor-card">
            <div class="monitor-trend trend-up">↗ +2GB</div>
            <h3>Data Size</h3>
            <div class="monitor-value" id="data-size">15.2TB</div>
            <div class="monitor-chart"><canvas id="dataChart"></canvas></div>
          </div>
          
          <div class="monitor-card">
            <div class="monitor-trend trend-down">↘ -3%</div>
            <h3>CPU Usage</h3>
            <div class="monitor-value" id="cpu-usage">67%</div>
            <div class="monitor-chart"><canvas id="cpuChart"></canvas></div>
          </div>
          
          <div class="monitor-card">
            <div class="monitor-trend trend-up">↗ +8%</div>
            <h3>Active Connections</h3>
            <div class="monitor-value" id="connections">432</div>
            <div class="monitor-chart"><canvas id="connectionsChart"></canvas></div>
          </div>
          
          <div class="monitor-card">
            <div class="monitor-trend trend-up">↗ +0.2%</div>
            <h3>Cache Hit Ratio</h3>
            <div class="monitor-value" id="cache-hit">94.7%</div>
            <div class="monitor-chart"><canvas id="cacheChart"></canvas></div>
          </div>
        </div>
        
        <div class="tool-card" style="margin-top: 20px;">
          <div class="tool-header">
            <i class="fas fa-bell"></i>
            <h3>Alert Console</h3>
          </div>
          <div class="terminal-output" id="alert-console">
            <div style="color: #00ff00;">[2024-01-15 14:30:22] INFO: All shards healthy</div>
            <div style="color: #ffff00;">[2024-01-15 14:29:18] WARN: Shard2 CPU usage above 80%</div>
            <div style="color: #00ff00;">[2024-01-15 14:28:45] INFO: Chunk migration completed: chunk_5 → shard3</div>
            <div style="color: #ff6666;">[2024-01-15 14:27:12] ERROR: Connection timeout to shard1 (resolved)</div>
            <div style="color: #00ff00;">[2024-01-15 14:26:33] INFO: Balancer cycle completed successfully</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chunk Detail Popup -->
    <div class="backdrop" id="chunk-backdrop"></div>
    <div class="chunk-popup" id="chunk-popup">
      <span class="close-popup" id="close-chunk-popup">&times;</span>
      <h3><i class="fas fa-cube"></i> Chi Tiết Chunk</h3>
      <div class="chunk-popup-content" id="chunk-popup-content">
        <p><strong>ID:</strong> <span id="chunk-id-detail"></span></p>
        <p><strong>Phạm vi (Range):</strong> <span id="chunk-range-detail"></span></p>
        <p><strong>Shard hiện tại:</strong> <span id="chunk-shard-detail"></span></p>
        <p><strong>Số lượng tài liệu (ước tính):</strong> <span id="chunk-docs-detail"></span></p>
      </div>
    </div>

  <script>
    // ====== Enhanced State Management ======
    let drag = { active: false, node: null, ghost: null, originShard: null };
    let currentDistribution = 'random';
    let currentShardKey = 'user_id';
    let distributionChart, performanceComparisonChart, scalabilityChart;
    let migrationChart, queryProfileChart;
    let monitoringCharts = {};
    let monitoringInterval;
    let particleInterval;

    // ====== Helpers ======
    const $ = (q, root = document) => root.querySelector(q);
    const $$ = (q, root = document) => Array.from(root.querySelectorAll(q));

    const shardsContainer = $('#shards-container');

    function getShardElements() { return $$('.shards-container .shard'); }
    
    // DYNAMICALLY route user ID based on current shard count
    function routeUserId(userId) {
      const shards = getShardElements();
      const numShards = shards.length;
      if (numShards === 0) return null;

      // Try to find chunk including userId
      const chunks = $$('.chunk');
      for (const ch of chunks) {
        const range = ch.getAttribute('data-range');
        if (range) {
          const [min, max] = range.split('-').map(n => parseInt(n, 10));
          if (userId >= min && userId <= max) {
            return ch.closest('.shard')?.id || shards[0].id;
          }
        }
      }

      // Fallback: simple distribution if no chunk matches
      const shardIndex = Math.floor((userId / 10000) * numShards) % numShards;
      return `shard${shardIndex + 1}`;
    }

    function createShard(id, label) {
      const el = document.createElement('div');
      el.className = 'shard';
      el.id = id;
      el.innerHTML = `
        <div class="shard-status"></div>
        <div class="shard-header"><i class="fas fa-database"></i> ${label}</div>
        <div class="chunks"></div>
      `;
      return el;
    }

    function createChunk(name, start) {
      const rangeStart = start ?? Math.floor(Math.random() * 9000) + 1;
      const rangeEnd = rangeStart + 999;
      const div = document.createElement('div');
      div.className = 'chunk';
      div.setAttribute('data-range', `${rangeStart}-${rangeEnd}`);
      div.innerHTML = `${name} <span>user_${rangeStart}-${rangeEnd}</span>`;
      bindChunkInteractive(div);
      return div;
    }

    function bindChunkInteractive(chunkEl) {
      // Click => open popup
      chunkEl.addEventListener('click', (e) => {
        if (drag.active) return; // avoid click while dragging
        const shardEl = chunkEl.closest('.shard');
        const idText = chunkEl.textContent.trim().split(' ')[0];
        const range = chunkEl.getAttribute('data-range');
        $('#chunk-id-detail').textContent = idText;
        $('#chunk-range-detail').textContent = range;
        $('#chunk-shard-detail').textContent = shardEl?.id || 'N/A';
        $('#chunk-docs-detail').textContent = '≈ ' + (1000 + Math.floor(Math.random() * 200)).toLocaleString();
        $('#chunk-backdrop').style.display = 'block';
        $('#chunk-popup').style.display = 'block';
      });

      // Drag using custom ghost (no duplicate)
      chunkEl.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return; // only left click
        drag.active = true;
        drag.node = chunkEl;
        drag.originShard = chunkEl.closest('.shard');
        chunkEl.style.opacity = '0.6';

        drag.ghost = document.createElement('div');
        drag.ghost.className = 'chunk-drag-ghost';
        drag.ghost.textContent = chunkEl.textContent.trim();
        document.body.appendChild(drag.ghost);
        moveGhost(e.pageX, e.pageY);

        // mark dropzones
        getShardElements().forEach((s) => s.classList.add('shard-dropzone'));
      });
    }

    function moveGhost(x, y) {
      if (!drag.ghost) return;
      drag.ghost.style.left = x + 'px';
      drag.ghost.style.top = y + 'px';
    }

    document.addEventListener('mousemove', (e) => {
      if (drag.active) moveGhost(e.pageX, e.pageY);
    });

    document.addEventListener('mouseup', (e) => {
      if (!drag.active) return;
      const drop = document.elementFromPoint(e.clientX, e.clientY)?.closest('.shard');
      if (drop && drop.querySelector('.chunks')) {
        drop.querySelector('.chunks').appendChild(drag.node);
        const range = drag.node.getAttribute('data-range');
        const consoleEl = $('#query-console');
        if (consoleEl) {
          consoleEl.innerHTML += `<div class="console-line console-success">&gt; Moved chunk (${range}) to ${drop.id}</div>`;
          consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        updateDistributionDisplay();
      }
      // cleanup
      drag.node.style.opacity = '1';
      drag.active = false;
      drag.node = null;
      drag.originShard = null;
      drag.ghost?.remove();
      drag.ghost = null;
      getShardElements().forEach((s) => s.classList.remove('shard-dropzone', 'highlight'));
    });

    // highlight while moving via mouseover
    document.addEventListener('mousemove', (e) => {
      if (!drag.active) return;
      getShardElements().forEach((s) => s.classList.remove('highlight'));
      const target = document.elementFromPoint(e.clientX, e.clientY)?.closest('.shard');
      if (target) target.classList.add('highlight');
    });

    // ====== NEW Data flow lines (Bus architecture) ======
    function initDataFlows() {
      const cluster = $('#interactive-cluster');
      // Remove old lines and bus
      $$('.data-flow, .data-flow-animation, .network-bus').forEach(el => el.remove());

      // Create bus
      const bus = document.createElement('div');
      bus.className = 'data-flow network-bus';
      cluster.appendChild(bus);

      const mongosNodes = $$('.mongos');
      const shardNodes = getShardElements();
      if (mongosNodes.length === 0 || shardNodes.length === 0) return;

      const containerRect = cluster.getBoundingClientRect();

      // Position bus
      const mongosBottom = Math.max(...mongosNodes.map(m => m.getBoundingClientRect().bottom));
      const shardsTop = Math.min(...shardNodes.map(s => s.getBoundingClientRect().top));
      const busTop = mongosBottom + (shardsTop - mongosBottom) * 0.5 - containerRect.top;
      const busLeft = shardNodes[0].getBoundingClientRect().left - containerRect.left + (shardNodes[0].getBoundingClientRect().width / 2);
      const lastShardRect = shardNodes[shardNodes.length - 1].getBoundingClientRect();
      const busRight = lastShardRect.left + lastShardRect.width / 2 - containerRect.left;
      
      bus.style.top = `${busTop}px`;
      bus.style.left = `${busLeft}px`;
      bus.style.width = `${busRight - busLeft}px`;

      // Create connectors
      const createConnector = (nodeRect, toBusTop) => {
        const line = document.createElement('div');
        line.className = 'data-flow';
        const nodeCenterX = nodeRect.left + nodeRect.width / 2 - containerRect.left;
        const startY = (toBusTop ? nodeRect.bottom : nodeRect.top) - containerRect.top;
        const endY = busTop;

        line.style.left = `${nodeCenterX}px`;
        line.style.top = `${Math.min(startY, endY)}px`;
        line.style.height = `${Math.abs(endY - startY)}px`;
        line.style.width = '4px'; // Vertical line
        cluster.appendChild(line);
      };

      mongosNodes.forEach(node => createConnector(node.getBoundingClientRect(), true));
      shardNodes.forEach(node => createConnector(node.getBoundingClientRect(), false));
    }

    function animateQueryFlow(fromSelector, toShardId) {
        const fromNode = $(fromSelector);
        const toNode = $(`#${toShardId}`);
        const cluster = $('#interactive-cluster');
        const bus = $('.network-bus');
        if (!fromNode || !toNode || !bus) return;

        const containerRect = cluster.getBoundingClientRect();
        const fromRect = fromNode.getBoundingClientRect();
        const toRect = toNode.getBoundingClientRect();
        const busRect = bus.getBoundingClientRect();

        const fromX = fromRect.left + fromRect.width / 2 - containerRect.left;
        const toX = toRect.left + toRect.width / 2 - containerRect.left;

        // Create 3 animated parts: from->bus, bus segment, bus->to
        const createAnimatedLine = (styles, duration, delay) => {
            const line = document.createElement('div');
            line.className = 'data-flow-animation';
            Object.assign(line.style, styles);
            line.style.animation = `flow ${duration}s linear ${delay}s`;
            cluster.appendChild(line);
            setTimeout(() => line.remove(), (duration + delay) * 1000 + 100);
        };

        // 1. From Mongos to Bus
        createAnimatedLine({
            left: `${fromX - 2}px`,
            top: `${fromRect.bottom - containerRect.top}px`,
            width: '4px',
            height: `${busRect.top - fromRect.bottom}px`,
            transformOrigin: 'top'
        }, 0.4, 0);

        // 2. Across Bus
        setTimeout(() => {
          const horizLine = document.createElement('div');
          horizLine.className = 'data-flow-animation';
          Object.assign(horizLine.style, {
            left: `${Math.min(fromX, toX)}px`,
            top: `${busRect.top - containerRect.top}px`,
            width: `${Math.abs(fromX - toX)}px`,
            height: '4px',
            transformOrigin: fromX < toX ? 'left' : 'right',
            animation: `flow-horiz 0.5s linear`
          });
          cluster.appendChild(horizLine);
          setTimeout(() => horizLine.remove(), 600);
        }, 300);
        
        // 3. From Bus to Shard
        setTimeout(() => {
           createAnimatedLine({
            left: `${toX - 2}px`,
            top: `${busRect.bottom - containerRect.top}px`,
            width: '4px',
            height: `${toRect.top - busRect.bottom}px`,
            transformOrigin: 'top'
          }, 0.4, 0);
        }, 700);
    }

    // Add specific keyframes for horizontal animation
    const styleSheet = document.createElement("style");
    styleSheet.type = "text/css";
    styleSheet.innerText = `
      @keyframes flow-horiz {
        from { transform: scaleX(0); } to { transform: scaleX(1); }
      }
    `;
    document.head.appendChild(styleSheet);

    window.addEventListener('resize', initDataFlows);

    // ====== Charts ======
    function initCharts() {
      // Overview chart
      const introCtx = $('#performanceChart').getContext('2d');
      new Chart(introCtx, {
        type: 'line',
        data: {
          labels: ['1M bản ghi', '10M', '100M', '1B'],
          datasets: [
            { label: 'Không Sharding (ms)', data: [100, 500, 5000, 12000], borderColor: 'rgba(255,99,132,1)', tension: 0.15 },
            { label: 'Có Sharding (ms)', data: [120, 200, 300, 500], borderColor: 'rgba(54,162,235,1)', tension: 0.15 },
          ],
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { y: { title: { display: true, text: 'Thời gian truy vấn (ms)' } } },
          plugins: { legend: { position: 'bottom' } },
        },
      });

      // Distribution chart (Interaction tab)
      const distCtx = $('#distributionChart').getContext('2d');
      distributionChart = new Chart(distCtx, {
        type: 'bar',
        data: { labels: ['Shard 1', 'Shard 2', 'Shard 3'], datasets: [{ label: 'Số chunk', data: [3, 3, 3] }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Số chunk' } } }, plugins: { legend: { display: false } } },
      });

      // Performance comparison chart
      const perfCtx = $('#performanceComparisonChart').getContext('2d');
      performanceComparisonChart = new Chart(perfCtx, {
        type: 'bar',
        data: {
          labels: ['Latency (ms)', 'Throughput (req/s)', 'CPU (%)'],
          datasets: [
            { label: 'Không sharding', data: [180, 400, 85] },
            { label: 'Có sharding', data: [42, 1250, 65] },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } },
      });

      // Scalability chart
      const scCtx = $('#scalabilityChart').getContext('2d');
      scalabilityChart = new Chart(scCtx, {
        type: 'line',
        data: {
          labels: [1, 2, 3],
          datasets: [
            { label: 'Throughput (k req/s)', data: [0.4, 0.8, 1.3] },
            { label: 'Latency (ms)', data: [180, 90, 42] },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Số Shard' } } }, plugins: { legend: { position: 'bottom' } } },
      });
    }

    function refreshDistributionChartFromUI() {
      if (!distributionChart) return;
      const counts = getShardElements().map((s) => s.querySelectorAll('.chunk').length);
      distributionChart.data.labels = counts.map((_, i) => 'Shard ' + (i + 1));
      distributionChart.data.datasets[0].data = counts;
      distributionChart.update();
    }

    // ====== Distribution display ======
    function updateDistributionDisplay() {
      const container = $('#distribution-effect');
      container.innerHTML = '';
      const shards = getShardElements();
      const counts = shards.map((s) => s.querySelectorAll('.chunk').length);
      const total = counts.reduce((a, b) => a + b, 0) || 1;
      shards.forEach((s, i) => {
        const percent = Math.round((counts[i] / total) * 100);
        const el = document.createElement('div');
        el.className = 'distribution-shard';
        el.textContent = `Shard ${i + 1}: ${percent}%`;
        if (percent < 25 && total > counts.length) el.style.background = 'rgba(76,175,80,0.18)';
        else if (percent > 45 && total > counts.length) el.style.background = 'rgba(255,152,0,0.18)';
        container.appendChild(el);
      });
      refreshDistributionChartFromUI();
      initDataFlows();
    }

    function getDistributionName(dist) {
      return ({ random: 'Ngẫu nhiên', shardkey: 'Theo Shard Key', loadbalance: 'Cân bằng tải', geo: 'Theo khu vực địa lý' })[dist] || dist;
    }

    // ====== Render initial shards & chunks ======
    function renderInitial() {
      shardsContainer.innerHTML = '';
      const labels = ['Shard 1 (USA)', 'Shard 2 (Europe)', 'Shard 3 (Asia)'];
      for (let i = 1; i <= 3; i++) {
        const s = createShard('shard' + i, labels[i - 1]);
        shardsContainer.appendChild(s);
      }
      // initial chunks
      const preset = [
        [['Chunk A', 1], ['Chunk D', 3001], ['Chunk G', 6001]],
        [['Chunk B', 1001], ['Chunk E', 4001], ['Chunk H', 7001]],
        [['Chunk C', 2001], ['Chunk F', 5001], ['Chunk I', 8001]],
      ];
      getShardElements().forEach((s, idx) => {
        const box = s.querySelector('.chunks');
        preset[idx].forEach(([name, start]) => box.appendChild(createChunk(name, start)));
      });
    }

    // ====== Buttons & Controls ======
    function wireControls() {
      // Add data
      $('#add-data').addEventListener('click', () => {
        const shards = getShardElements();
        if (shards.length === 0) return;
        let target;
        
        // Select target shard based on strategy
        if (currentDistribution === 'loadbalance') {
          target = shards.reduce((min, s) => (s.querySelectorAll('.chunk').length < min.querySelectorAll('.chunk').length ? s : min), shards[0]);
        } else if (currentDistribution === 'geo') {
            const geoTargets = ['USA', 'Europe', 'Asia'];
            const targetGeo = geoTargets[Math.floor(Math.random() * geoTargets.length)];
            target = shards.find(s => s.textContent.includes(targetGeo)) || shards[Math.floor(Math.random() * shards.length)];
        } else { // random or shardkey (simplified to random for this simulation)
          target = shards[Math.floor(Math.random() * shards.length)];
        }

        const chunkNames = 'JKLMNOPQRSTUVWXYZ'.split('').map((c) => 'Chunk ' + c);
        const name = chunkNames[Math.floor(Math.random() * chunkNames.length)];
        const newChunk = createChunk(name);
        newChunk.style.opacity = '0';
        newChunk.style.transform = 'translateY(10px)';

        // Highlight target shard before adding
        target.style.transition = 'box-shadow 0.2s ease-out';
        target.style.boxShadow = '0 0 18px var(--success)';
        setTimeout(() => target.style.boxShadow = '', 500);

        target.querySelector('.chunks').appendChild(newChunk);
        requestAnimationFrame(() => {
          newChunk.style.transition = 'all .25s ease';
          newChunk.style.opacity = '1';
          newChunk.style.transform = 'translateY(0)';
        });

        const consoleEl = $('#query-console');
        if (consoleEl) {
          consoleEl.innerHTML += `<div class="console-line console-success">&gt; Added ${name} to ${target.id} (Strategy: ${getDistributionName(currentDistribution)})</div>`;
          consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        $('#chunk-count').textContent = parseInt($('#chunk-count').textContent, 10) + 1;
        updateDistributionDisplay();
      });

      // Rebalance
      $('#rebalance').addEventListener('click', () => {
        const shards = getShardElements();
        if (shards.length < 2) return;
        const all = [];
        shards.forEach((s) => $$('.chunk', s).forEach((c) => all.push(c)));
        shards.forEach((s) => s.querySelector('.chunks').innerHTML = '');
        // round-robin
        let i = 0;
        all.forEach((c) => {
          shards[i % shards.length].querySelector('.chunks').appendChild(c);
          i++;
        });
        shards.forEach((s) => { s.style.boxShadow = '0 0 18px rgba(255,215,0,.7)'; setTimeout(() => s.style.boxShadow = '', 900); });
        const consoleEl = $('#query-console');
        if (consoleEl) {
          consoleEl.innerHTML += `<div class="console-line console-success">&gt; Data rebalanced across shards</div>`;
          consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        updateDistributionDisplay();
      });
    }

    // Visual highlight for a routed shard
    function highlightShard(shardId) {
      const el = document.getElementById(shardId);
      if (!el) return;
      el.style.boxShadow = '0 0 18px rgba(0,188,212,.9)';
      setTimeout(() => (el.style.boxShadow = ''), 1200);
    }

    // Show routed result in visual panel (if exists)
    function showRouteResult(shardId, payloadText = '') {
      const visual = $('#query-visual');
      if (!visual) return;
      visual.innerHTML = `
        <p style="margin-top: 20px;"><strong>Đã định tuyến tới:</strong> <span style="color: var(--primary); font-weight: bold;">${shardId}</span></p>
        ${payloadText ? `<p><strong>Dữ liệu truy vấn:</strong> <code>${payloadText}</code></p>` : ''}
      `;
    }

    function simulateAndAnimateQuery(sourceMongosSelector) {
        const userId = Math.floor(Math.random() * 9999) + 1;
        const shardId = routeUserId(userId);
        if (!shardId) return;

        const consoleEl = $('#query-console');
        const sourceName = $(sourceMongosSelector).textContent.trim();
        if (consoleEl) {
            consoleEl.innerHTML += `<div class="console-line">&gt; ${sourceName}: { "user_id": ${userId} }</div>`;
            consoleEl.innerHTML += `<div class="console-line console-success">→ Routed to <b>${shardId}</b></div>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        highlightShard(shardId);
        animateQueryFlow(sourceMongosSelector, shardId);
        showRouteResult(shardId, `{ "user_id": ${userId} }`);
    }

    // Bind simulate-query button
    $('#simulate-query').addEventListener('click', () => simulateAndAnimateQuery('#mongos1'));

    // Bind Mongos click
    $$('.mongos').forEach(m => m.addEventListener('click', () => simulateAndAnimateQuery(`#${m.id}`)));


    // ====== Tabs & FAQ ======
    function wireTabsAndFaq() {
      $$('.tab').forEach((t) => {
        t.addEventListener('click', () => {
          $$('.tab').forEach((x) => x.classList.remove('active'));
          t.classList.add('active');
          const target = t.getAttribute('data-tab');
          $$('.tab-content').forEach((c) => c.classList.remove('active'));
          $(`#${target}-tab`).classList.add('active');
          // redraw flows when switching back to visualization
          if (target === 'visualization') requestAnimationFrame(initDataFlows);
        });
      });

      $$('.faq-item').forEach((item) => {
        item.querySelector('.faq-question').addEventListener('click', () => {
          item.classList.toggle('active');
        });
      });
    }

    // ====== Chunk detail popup close ======
    $('#close-chunk-popup').addEventListener('click', () => {
      $('#chunk-popup').style.display = 'none';
      $('#chunk-backdrop').style.display = 'none';
    });
    $('#chunk-backdrop').addEventListener('click', () => {
      $('#chunk-popup').style.display = 'none';
      $('#chunk-backdrop').style.display = 'none';
    });

    // ====== Config popup ======
    const configPopup = $('#config-popup');
    function openConfigPopupNear(el) {
      configPopup.style.display = 'block';
      const r = el.getBoundingClientRect();
      const parent = $('#interactive-cluster').getBoundingClientRect();
      configPopup.style.left = (r.left - parent.left + r.width + 12) + 'px';
      configPopup.style.top = (r.top - parent.top) + 'px';
    }
    $$('.config-server').forEach(el => {
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        openConfigPopupNear(el);
      });
    });
    $('#close-config-popup').addEventListener('click', () => (configPopup.style.display = 'none'));
    document.addEventListener('click', (e) => {
      if (!configPopup.contains(e.target) && !e.target.closest('.config-server')) {
        configPopup.style.display = 'none';
      }
    });

    // ====== Shards/Chunks slider handlers ======
    function regenerateShards(n) {
      // gather all chunks
      const existingChunks = [];
      getShardElements().forEach((s) => $$('.chunk', s).forEach((c) => existingChunks.push(c)));
      // clear and rebuild shards
      shardsContainer.innerHTML = '';
      for (let i = 1; i <= n; i++) {
        const s = createShard('shard' + i, 'Shard ' + i);
        shardsContainer.appendChild(s);
      }
      // reattach existing chunks round-robin
      let i = 0;
      existingChunks.forEach((c) => {
        const target = getShardElements()[i % n].querySelector('.chunks');
        target.appendChild(c);
        i++;
      });
      initDataFlows();
      updateDistributionDisplay();
    }

    function ensureChunkCount(targetCount) {
      const shards = getShardElements();
      if (shards.length === 0) return;
      const allChunks = $$('.chunk');
      let current = allChunks.length;

      while (current < targetCount) {
        const target = shards[Math.floor(Math.random() * shards.length)];
        const newChunk = createChunk('Chunk ' + String.fromCharCode(65 + (current % 26)));
        target.querySelector('.chunks').appendChild(newChunk);
        current++;
      }

      while (current > targetCount) {
        const last = $$('.chunk').pop();
        if (!last) break;
        last.remove();
        current--;
      }
      updateDistributionDisplay();
    }

    $('#shards').addEventListener('input', (e) => $('#shard-count').textContent = e.target.value);
    $('#shards').addEventListener('change', (e) => {
      const n = parseInt(e.target.value, 10);
      regenerateShards(n);
      refreshDistributionChartFromUI();
    });

    $('#chunks').addEventListener('input', (e) => $('#chunk-count').textContent = e.target.value);
    $('#chunks').addEventListener('change', (e) => ensureChunkCount(parseInt(e.target.value, 10)));

    const distributionExplanations = {
        random: '<h3><i class="fas fa-random"></i> Ngẫu nhiên</h3><p>Dữ liệu mới được thêm vào một shard ngẫu nhiên. Đơn giản nhưng có thể không tối ưu cho việc đọc theo phạm vi (range scan).</p>',
        shardkey: '<h3><i class="fas fa-key"></i> Theo Shard Key</h3><p>Dữ liệu được phân phối dựa trên giá trị của shard key. Hiệu quả cho truy vấn theo phạm vi nếu key được chọn tốt.</p>',
        loadbalance: '<h3><i class="fas fa-balance-scale"></i> Cân bằng tải</h3><p>Dữ liệu mới được thêm vào shard có ít chunk nhất, giúp giữ cho các shard cân bằng về số lượng chunk.</p>',
        geo: '<h3><i class="fas fa-globe-americas"></i> Theo khu vực địa lý</h3><p>Dữ liệu được phân phối đến các shard đặt tại các vị trí địa lý cụ thể, giúp giảm độ trễ cho người dùng khu vực đó.</p>'
    };
    $('#data-distribution').addEventListener('change', (e) => {
      currentDistribution = e.target.value;
      const explanationBox = $('#distribution-explanation');
      explanationBox.innerHTML = distributionExplanations[currentDistribution] || '';
      explanationBox.style.display = 'block';

      const consoleEl = $('#query-console');
      if (consoleEl) {
        consoleEl.innerHTML += `<div class="console-line console-comment"># Changed distribution strategy to: ${getDistributionName(currentDistribution)}</div>`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
      }
    });


    // ====== Interaction tab: shard key options ======
    $$('.key-option').forEach((opt) => {
      opt.addEventListener('click', () => {
        $$('.key-option').forEach((x) => x.classList.remove('active'));
        opt.classList.add('active');
        currentShardKey = opt.dataset.key || 'user_id';

        const labels = ['Shard 1', 'Shard 2', 'Shard 3'];
        let data = [5, 5, 5];
        let explanation = '';

        if (currentShardKey === 'user_id') {
          data = [6, 5, 6];
          explanation = `<p><strong>Giải thích:</strong> "user_id" với cardinality cao thường phân phối đều, tốt cho cả đọc và ghi.</p>`;
        } else if (currentShardKey === 'timestamp') {
          data = [2, 3, 12]; // Hot shard effect
          explanation = `<p><strong>Giải thích:</strong> "timestamp" có nguy cơ gây ra "hot shard" vì tất cả lượt ghi mới đều đi vào shard cuối cùng.</p>`;
        } else if (currentShardKey === 'location') {
          data = [8, 2, 7]; // Uneven but logical
          explanation = `<p><strong>Giải thích:</strong> "location" giúp định tuyến theo khu vực, nhưng có thể không đều nếu lưu lượng không cân bằng giữa các khu vực.</p>`;
        } else {
          data = [4, 8, 5];
          explanation = `<p><strong>Giải thích:</strong> Shard key dựa trên "product" có thể gây ra hot shard nếu một sản phẩm đột nhiên trở nên phổ biến.</p>`;
        }

        $('#key-explanation').innerHTML = explanation;
        if (distributionChart) {
          distributionChart.data.labels = labels;
          distributionChart.data.datasets[0].data = data;
          distributionChart.update();
        }
      });
    });

    // ====== Interaction tab: Run query from input ======
    $('#run-query').addEventListener('click', () => {
      const txt = $('#interactive-query').value.trim();
      const consoleEl = $('#query-console');
      consoleEl.innerHTML += `<div class="console-line console-command">&gt; ${txt}</div>`;
      if (!txt) return;

      let obj, shardId;
      try {
        obj = JSON.parse(txt);
      } catch (e) {
        consoleEl.innerHTML += `<div class="console-line console-error">! Invalid JSON</div>`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
        return;
      }

      if (typeof obj.user_id === 'number') {
        shardId = routeUserId(obj.user_id);
      } else {
        const firstKey = Object.keys(obj)[0];
        const val = obj[firstKey];
        const n = getShardElements().length || 3;
        const hash = String(val).split('').reduce((a, c) => a + c.charCodeAt(0), 0) % n;
        shardId = `shard${hash + 1}`;
      }

      if (!shardId) {
        consoleEl.innerHTML += `<div class="console-line console-error">! Could not route query. No shards available.</div>`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
        return;
      }

      consoleEl.innerHTML += `<div class="console-line console-success">→ Routed to <b>${shardId}</b></div>`;
      consoleEl.scrollTop = consoleEl.scrollHeight;
      highlightShard(shardId);
      animateQueryFlow('#mongos2', shardId); // Assume query from second mongos
      showRouteResult(shardId, txt);
    });

    // ====== Interaction tab: Design Architecture (FIXED) ======
    $('#design-architecture').addEventListener('click', () => {
        const numShards = parseInt($('#custom-shards').value, 10);
        const dataSize = $('#custom-data').value;
        const resultEl = $('#architecture-result');

        let recommendation = `<p>Với <strong>${numShards} shards</strong> và <strong>${dataSize}</strong> dữ liệu:</p>`;
        recommendation += `<ul><li><strong>Cấu hình đề xuất:</strong> Mỗi shard nên là một replica set (1 primary, 2 secondaries) để đảm bảo tính sẵn sàng cao (High Availability).</li>`;
        
        if (numShards <= 3 && ['100TB', '1PB'].includes(dataSize)) {
            recommendation += `<li style="color:var(--warning);"><strong>Cảnh báo:</strong> ${numShards} shards có thể là quá ít cho ${dataSize} dữ liệu. Cân nhắc tăng số lượng shard để cải thiện hiệu suất ghi và phân tán tải.</li>`;
        } else if (numShards >= 10 && dataSize === '1TB') {
            recommendation += `<li style="color:var(--warning);"><strong>Lưu ý:</strong> ${numShards} shards có thể là quá nhiều cho ${dataSize} dữ liệu, gây tăng chi phí và độ phức tạp quản lý không cần thiết.</li>`;
        } else {
            recommendation += `<li style="color:var(--success);"><strong>Nhận xét:</strong> Cấu hình này có vẻ hợp lý.</li>`;
        }
        recommendation += `</ul>`;

        let visual = '<div style="display: flex; justify-content: center; gap: 12px; margin: 14px 0; flex-wrap: wrap;">';
        for (let i = 1; i <= numShards; i++) {
            visual += `<div class="shard-mini" title="Shard ${i} Replica Set">Shard ${i}</div>`;
        }
        visual += '</div>';

        resultEl.innerHTML = visual + recommendation;
    });


    // ====== Performance tab: load slider & add shard chart ======
    const loadMap = { 1: 'Thấp', 2: 'Trung bình', 3: 'Cao' };
    $('#load-level').addEventListener('input', (e) => {
      const v = parseInt(e.target.value, 10);
      $('#load-value').textContent = loadMap[v];

      // Make changes more dramatic for better feedback
      const baseThroughput = v === 1 ? 900 : v === 2 ? 1250 : 1800;
      const baseLatency = v === 1 ? 28 : v === 2 ? 42 : 78;
      const baseCPU = v === 1 ? 45 : v === 2 ? 65 : 88;

      $('#throughput-value').textContent = baseThroughput.toLocaleString();
      $('#latency-value').textContent = baseLatency + 'ms';
      $('#cpu-value').textContent = baseCPU + '%';

      if (performanceComparisonChart) {
        performanceComparisonChart.data.datasets[0].data = [baseLatency * 5, Math.round(baseThroughput / 3.5), Math.min(95, baseCPU + 10)];
        performanceComparisonChart.data.datasets[1].data = [baseLatency, baseThroughput, baseCPU];
        performanceComparisonChart.update();
      }
    });

    $('#add-shard').addEventListener('click', () => {
      if (!scalabilityChart) return;
      const currentLabels = scalabilityChart.data.labels;
      if (currentLabels.length >= 10) return; // Cap at 10 shards for demo
      const nextShardCount = currentLabels[currentLabels.length - 1] + 1;
      scalabilityChart.data.labels.push(nextShardCount);

      // naive growth: throughput up, latency down (diminishing returns)
      const lastT = scalabilityChart.data.datasets[0].data.slice(-1)[0];
      const lastL = scalabilityChart.data.datasets[1].data.slice(-1)[0];
      const newT = +(lastT + Math.max(0.15, 0.4 / nextShardCount)).toFixed(2);
      const newL = Math.max(18, Math.round(lastL * 0.9));

      scalabilityChart.data.datasets[0].data.push(newT);
      scalabilityChart.data.datasets[1].data.push(newL);
      scalabilityChart.update();
    });

    // ====== Boot ======
    (function boot() {
      renderInitial();
      initCharts();
      wireControls();
      wireTabsAndFaq();
      updateDistributionDisplay();
      // Set initial explanation for default strategy
      const explanationBox = $('#distribution-explanation');
      explanationBox.innerHTML = distributionExplanations[currentDistribution];
      explanationBox.style.display = 'block';
      // Initial draw of bus lines
      requestAnimationFrame(initDataFlows);
      
      // Initialize new features
      initTheme();
      startParticleEffect();
      initAdvancedTools();
      initMonitoring();
    })();

    // ====== Theme Toggle ======
    function initTheme() {
      const themeToggle = $('#theme-toggle');
      if (!themeToggle) return;
      
      const currentTheme = localStorage.getItem('theme') || 'light';
      
      if (currentTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }
      
      themeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        if (isDark) {
          document.documentElement.removeAttribute('data-theme');
          themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.setAttribute('data-theme', 'dark');
          themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
          localStorage.setItem('theme', 'dark');
        }
      });
    }

    // ====== Particle Effects ======
    function createParticle() {
      const cluster = $('#interactive-cluster');
      if (!cluster) return;
      
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 6 + 's';
      particle.style.animationDuration = (6 + Math.random() * 4) + 's';
      
      cluster.appendChild(particle);
      
      setTimeout(() => {
        if (particle.parentNode) {
          particle.parentNode.removeChild(particle);
        }
      }, 10000);
    }

    function startParticleEffect() {
      particleInterval = setInterval(createParticle, 3000);
    }

    // ====== Advanced Tools ======
    function initAdvancedTools() {
      // Shard Key Analyzer
      const analyzeBtn = $('#analyze-shard-key');
      if (analyzeBtn) {
        analyzeBtn.addEventListener('click', () => {
          const data = $('#data-sample').value;
          const result = $('#shard-analysis-result');
          
          if (!data.trim()) {
            result.innerHTML = '<div style="color: #ff6666;">Please provide sample data</div>';
            return;
          }
          
          try {
            const parsed = JSON.parse(data);
            const keys = Object.keys(parsed);
            let analysis = '<div style="color: #00ff00;">Analysis Results:</div>';
            
            keys.forEach(key => {
              const value = parsed[key];
              let cardinality = 'Unknown';
              let recommendation = '';
              
              if (key.includes('id')) {
                cardinality = 'High';
                recommendation = 'Excellent for even distribution';
              } else if (key.includes('timestamp') || key.includes('date')) {
                cardinality = 'High';
                recommendation = 'WARNING: May cause hot shard issue';
              } else if (key.includes('location') || key.includes('region')) {
                cardinality = 'Medium';
                recommendation = 'Good for geo-distributed queries';
              } else {
                cardinality = 'Medium';
                recommendation = 'Analyze data distribution patterns';
              }
              
              analysis += `<div>• ${key}: Cardinality=${cardinality} - ${recommendation}</div>`;
            });
            
            result.innerHTML = analysis;
          } catch (e) {
            result.innerHTML = '<div style="color: #ff6666;">Invalid JSON format</div>';
          }
        });
      }
      
      // Migration Simulator
      const migrateBtn = $('#simulate-migration');
      if (migrateBtn) {
        migrateBtn.addEventListener('click', () => {
          const strategy = $('#migration-strategy').value;
          const count = $('#chunks-to-migrate').value;
          
          // Create migration chart if doesn't exist
          const canvas = $('#migrationChart');
          if (canvas && !migrationChart) {
            migrationChart = new Chart(canvas.getContext('2d'), {
              type: 'line',
              data: {
                labels: ['Before', 'During', 'After'],
                datasets: [{
                  label: 'Latency (ms)',
                  data: [42, 85, 38],
                  borderColor: 'rgba(255,99,132,1)'
                }, {
                  label: 'Throughput (ops/s)',
                  data: [1200, 800, 1350],
                  borderColor: 'rgba(54,162,235,1)'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
              }
            });
          }
          
          if (migrationChart) {
            // Simulate different migration impacts
            const impacts = {
              manual: { latency: [42, 90, 35], throughput: [1200, 750, 1400] },
              'auto-balance': { latency: [42, 65, 40], throughput: [1200, 950, 1300] },
              'drain-shard': { latency: [42, 120, 32], throughput: [1200, 600, 1500] },
              'zone-migration': { latency: [42, 75, 38], throughput: [1200, 850, 1350] }
            };
            
            const impact = impacts[strategy] || impacts.manual;
            migrationChart.data.datasets[0].data = impact.latency;
            migrationChart.data.datasets[1].data = impact.throughput;
            migrationChart.update();
          }
        });
      }
      
      // Security Checker
      const securityBtn = $('#run-security-check');
      if (securityBtn) {
        securityBtn.addEventListener('click', () => {
          const authCheck = $('#check-auth').checked;
          const sslCheck = $('#check-ssl').checked;
          const auditCheck = $('#check-audit').checked;
          const result = $('#security-result');
          
          let score = 0;
          let report = '<div style="color: #00ff00;">Security Assessment:</div>';
          
          if (authCheck) {
            score += 40;
            report += '<div style="color: #00ff00;">✓ Authentication: ENABLED</div>';
          } else {
            report += '<div style="color: #ff6666;">✗ Authentication: DISABLED</div>';
          }
          
          if (sslCheck) {
            score += 35;
            report += '<div style="color: #00ff00;">✓ SSL/TLS: ENABLED</div>';
          } else {
            report += '<div style="color: #ffff00;">⚠ SSL/TLS: DISABLED</div>';
          }
          
          if (auditCheck) {
            score += 25;
            report += '<div style="color: #00ff00;">✓ Audit Logging: ENABLED</div>';
          } else {
            report += '<div style="color: #ffff00;">⚠ Audit Logging: DISABLED</div>';
          }
          
          let riskLevel = 'HIGH';
          let color = '#ff6666';
          if (score >= 80) { riskLevel = 'LOW'; color = '#00ff00'; }
          else if (score >= 50) { riskLevel = 'MEDIUM'; color = '#ffff00'; }
          
          report += `<div style="color: ${color}; margin-top: 10px;">Security Score: ${score}/100 (${riskLevel} RISK)</div>`;
          result.innerHTML = report;
        });
      }
      
      // Query Profiler
      const profileBtn = $('#profile-query');
      if (profileBtn) {
        profileBtn.addEventListener('click', () => {
          const query = $('#query-input').value;
          const canvas = $('#queryProfileChart');
          
          if (canvas && !queryProfileChart) {
            queryProfileChart = new Chart(canvas.getContext('2d'), {
              type: 'bar',
              data: {
                labels: ['Shard 1', 'Shard 2', 'Shard 3'],
                datasets: [{
                  label: 'Execution Time (ms)',
                  data: [25, 30, 28],
                  backgroundColor: ['rgba(26,115,232,0.7)', 'rgba(0,188,212,0.7)', 'rgba(76,175,80,0.7)']
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
              }
            });
          }
          
          if (queryProfileChart) {
            // Simulate query profiling
            const times = [Math.random() * 50 + 10, Math.random() * 50 + 10, Math.random() * 50 + 10];
            queryProfileChart.data.datasets[0].data = times;
            queryProfileChart.update();
          }
        });
      }
      
      // Wire migration count slider
      const migrationSlider = $('#chunks-to-migrate');
      if (migrationSlider) {
        migrationSlider.addEventListener('input', (e) => {
          $('#migration-count').textContent = e.target.value;
        });
      }
    }

    // ====== Real-time Monitoring ======
    function initMonitoring() {
      // Initialize monitoring charts
      const chartConfigs = [
        { id: 'opsChart', label: 'Operations', color: 'rgba(26,115,232,1)' },
        { id: 'latencyChart', label: 'Latency', color: 'rgba(255,152,0,1)' },
        { id: 'dataChart', label: 'Data Size', color: 'rgba(76,175,80,1)' },
        { id: 'cpuChart', label: 'CPU', color: 'rgba(244,67,54,1)' },
        { id: 'connectionsChart', label: 'Connections', color: 'rgba(156,39,176,1)' },
        { id: 'cacheChart', label: 'Cache', color: 'rgba(0,188,212,1)' }
      ];
      
      chartConfigs.forEach(config => {
        const canvas = $('#' + config.id);
        if (canvas) {
          monitoringCharts[config.id] = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
              labels: Array.from({length: 10}, (_, i) => i),
              datasets: [{
                label: config.label,
                data: Array.from({length: 10}, () => Math.random() * 100),
                borderColor: config.color,
                fill: false,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { display: false },
                y: { display: false }
              }
            }
          });
        }
      });
      
      // Start real-time updates
      startMonitoringUpdates();
    }
    
    function startMonitoringUpdates() {
      monitoringInterval = setInterval(() => {
        // Update monitoring values
        const updates = {
          'ops-per-sec': () => Math.floor(Math.random() * 500 + 1000),
          'avg-latency': () => Math.floor(Math.random() * 20 + 35) + 'ms',
          'data-size': () => (Math.random() * 2 + 14).toFixed(1) + 'TB',
          'cpu-usage': () => Math.floor(Math.random() * 30 + 50) + '%',
          'connections': () => Math.floor(Math.random() * 100 + 400),
          'cache-hit': () => (Math.random() * 5 + 92).toFixed(1) + '%'
        };
        
        Object.entries(updates).forEach(([id, generator]) => {
          const element = $('#' + id);
          if (element) {
            element.textContent = generator();
          }
        });
        
        // Update charts
        Object.values(monitoringCharts).forEach(chart => {
          if (chart && chart.data.datasets[0]) {
            chart.data.datasets[0].data.shift();
            chart.data.datasets[0].data.push(Math.random() * 100);
            chart.update('none');
          }
        });
        
        // Add random alerts
        if (Math.random() < 0.1) {
          addAlert();
        }
      }, 2000);
    }
    
    function addAlert() {
      const alertConsole = $('#alert-console');
      if (!alertConsole) return;
      
      const alerts = [
        { level: 'INFO', color: '#00ff00', msg: 'Chunk balancing completed successfully' },
        { level: 'WARN', color: '#ffff00', msg: 'High memory usage detected on shard2' },
        { level: 'INFO', color: '#00ff00', msg: 'New secondary node added to replica set' },
        { level: 'ERROR', color: '#ff6666', msg: 'Temporary connection loss to config server (recovered)' }
      ];
      
      const alert = alerts[Math.floor(Math.random() * alerts.length)];
      const timestamp = new Date().toLocaleString();
      const newAlert = document.createElement('div');
      newAlert.style.color = alert.color;
      newAlert.textContent = `[${timestamp}] ${alert.level}: ${alert.msg}`;
      
      alertConsole.insertBefore(newAlert, alertConsole.firstChild);
      
      // Keep only last 10 alerts
      while (alertConsole.children.length > 10) {
        alertConsole.removeChild(alertConsole.lastChild);
      }
    }
  </script>
</body>
</html>